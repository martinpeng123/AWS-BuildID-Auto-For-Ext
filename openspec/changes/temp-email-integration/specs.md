# 临时邮箱集成 - 技术规格

## 确定的约束参数

### 轮询配置
| 参数 | 值 | 说明 |
|------|-----|------|
| `POLL_INITIAL_INTERVAL_MS` | 3000 | 初始轮询间隔 3 秒 |
| `POLL_MAX_INTERVAL_MS` | 15000 | 最大轮询间隔 15 秒 |
| `POLL_BACKOFF_FACTOR` | 1.5 | 指数退避因子 |
| `POLL_TIMEOUT_MS` | 180000 | 总超时 3 分钟 |
| `POLL_JITTER_MS` | 500 | 随机抖动 ±500ms |

### 重试配置
| 参数 | 值 | 说明 |
|------|-----|------|
| `MAX_RETRIES` | 3 | 可恢复错误最大重试次数 |
| `REQUEST_TIMEOUT_MS` | 15000 | 单次 HTTP 请求超时 15 秒 |
| `RECOVERABLE_ERRORS` | `[429, 500, 502, 503, 504, 'NetworkError']` | 可恢复错误类型 |
| `NON_RECOVERABLE_ERRORS` | `[400, 401, 403, 404]` | 不可恢复错误类型 |

### 并发与存储
| 参数 | 值 | 说明 |
|------|-----|------|
| `MAX_CONCURRENT_POLLS` | 1 | 最大并发轮询数 |
| `JWT_STORAGE` | `memory` | JWT 仅存内存，不持久化 |
| `CONFIG_STORAGE` | `chrome.storage.local` | 配置持久化存储 |

### 验证码提取
| 参数 | 值 | 说明 |
|------|-----|------|
| `EXTRACTION_PRIORITY` | `['metadata.auth_code', 'text', 'html']` | 提取优先级 |
| `SUBJECT_KEYWORDS` | `['amazon', 'aws', 'verification', 'verify', 'code']` | 主题过滤关键词 |
| `CODE_REGEX` | `/\b(\d{6})\b/g` | 6 位数字正则 |
| `CODE_CONTEXT_REGEX` | `/(?:verification|code|verify)[^0-9]*(\d{6})/i` | 上下文增强正则 |

### 默认行为
| 配置 | 值 | 说明 |
|------|-----|------|
| `DEFAULT_MODE` | `temp-email` | 新用户默认临时邮箱模式 |
| `EXISTING_USER_MODE` | `temp-email` | 现有用户更新后也切换到临时邮箱 |

---

## PBT Properties (属性测试)

### P1: 验证码提取幂等性
```
INVARIANT: extractVerificationCode(email) 对同一邮件多次调用返回相同结果
FALSIFICATION: 生成随机邮件内容，多次调用比较结果
```

### P2: 轮询间隔单调递增
```
INVARIANT: 每次失败后 interval >= previousInterval
BOUNDARY: interval <= POLL_MAX_INTERVAL_MS
FALSIFICATION: 模拟连续失败，验证间隔序列单调性
```

### P3: JWT 生命周期绑定
```
INVARIANT: JWT 仅在对应 session 存活期间有效
PROPERTY: session 结束后 JWT 不可用
FALSIFICATION: session 结束后尝试使用 JWT 发起请求
```

### P4: 重试次数上界
```
INVARIANT: 可恢复错误重试次数 <= MAX_RETRIES
PROPERTY: 超过次数后返回最终错误
FALSIFICATION: 模拟持续失败，验证第 4 次不再重试
```

### P5: 并发互斥
```
INVARIANT: 同时只有 1 个活跃轮询
PROPERTY: 新轮询请求取消旧轮询
FALSIFICATION: 并发启动多个轮询，验证只有 1 个活跃
```

### P6: 配置完整性
```
INVARIANT: 必填配置缺失时无法启动注册
PROPERTY: apiUrl, adminPassword, domain 均为必填
FALSIFICATION: 分别移除每个必填项，验证启动失败
```

### P7: 邮件时间窗口
```
INVARIANT: 只处理创建邮箱后收到的邮件
PROPERTY: 忽略 created_at < inbox_created_at 的邮件
FALSIFICATION: 注入旧邮件，验证被过滤
```

### P8: 模式隔离
```
INVARIANT: 模式切换不影响另一模式的配置
PROPERTY: Gmail 配置与临时邮箱配置独立存储
FALSIFICATION: 切换模式后验证原配置保持不变
```

---

## 错误分类与处理

### 错误类型定义
```javascript
const ErrorTypes = {
  NETWORK_ERROR: 'NETWORK_ERROR',       // 网络不可达
  TIMEOUT_ERROR: 'TIMEOUT_ERROR',       // 请求超时
  AUTH_ERROR: 'AUTH_ERROR',             // 401/403 鉴权失败
  RATE_LIMIT_ERROR: 'RATE_LIMIT_ERROR', // 429 限流
  SERVER_ERROR: 'SERVER_ERROR',         // 5xx 服务端错误
  CONFIG_ERROR: 'CONFIG_ERROR',         // 400 配置/参数错误
  PARSE_ERROR: 'PARSE_ERROR',           // 响应解析失败
  EXTRACTION_ERROR: 'EXTRACTION_ERROR', // 验证码提取失败
  POLL_TIMEOUT: 'POLL_TIMEOUT'          // 轮询总超时
};
```

### 处理策略
| 错误类型 | 可恢复 | 处理方式 |
|----------|--------|----------|
| NETWORK_ERROR | 是 | 指数退避重试 |
| TIMEOUT_ERROR | 是 | 指数退避重试 |
| RATE_LIMIT_ERROR | 是 | 遵循 Retry-After 或退避 |
| SERVER_ERROR | 是 | 指数退避重试 |
| AUTH_ERROR | 否 | 立即失败，提示检查配置 |
| CONFIG_ERROR | 否 | 立即失败，提示检查参数 |
| PARSE_ERROR | 否 | 立即失败，记录日志 |
| EXTRACTION_ERROR | 部分 | 继续轮询下一封邮件 |
| POLL_TIMEOUT | 否 | 最终失败，提供手动输入选项 |

---

## 接口契约

### TempEmailClient Interface
```typescript
interface TempEmailClient {
  // 配置
  configure(config: TempEmailConfig): void;
  isConfigured(): boolean;

  // 邮箱生命周期
  createInbox(options?: CreateInboxOptions): Promise<InboxResult>;
  deleteInbox(): Promise<void>;

  // 验证码获取
  waitForVerificationCode(timeout?: number): Promise<string>;
  cancelPolling(): void;

  // 状态
  getAddress(): string | null;
  getStats(): PollStats;
}

interface TempEmailConfig {
  apiUrl: string;      // 必填，如 https://api.example.com
  adminPassword: string; // 必填
  domain: string;      // 必填，如 awsl.uk
}

interface InboxResult {
  address: string;     // 创建的邮箱地址
  jwt: string;         // API 访问令牌
  createdAt: number;   // 创建时间戳
}

interface CreateInboxOptions {
  name?: string;       // 自定义邮箱名（可选）
  enablePrefix?: boolean; // 是否添加前缀，默认 true
}

interface PollStats {
  attempts: number;    // 轮询次数
  errors: number;      // 错误次数
  lastInterval: number; // 最后一次间隔
  startedAt: number;   // 开始时间
}
```

---

## UI 状态机

```
[未配置] --配置完成--> [已配置/空闲]
[已配置/空闲] --开始注册--> [创建邮箱中]
[创建邮箱中] --成功--> [轮询验证码中]
[创建邮箱中] --失败--> [错误]
[轮询验证码中] --获取成功--> [自动填写中]
[轮询验证码中] --超时--> [手动输入模式]
[轮询验证码中] --取消--> [已配置/空闲]
[自动填写中] --完成--> [注册成功]
[手动输入模式] --用户输入--> [注册成功]
[错误] --重试--> [创建邮箱中]
[错误] --重新配置--> [未配置]
```

---

*Generated by CCG:SPEC:PLAN at 2026-02-10*
